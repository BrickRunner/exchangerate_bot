# Руководство по миграции

## Обновление с версии 1.0 на 1.1

### Что изменилось

1. **Часовые пояса теперь в формате UTC**
   - Было: GMT+0, GMT+1, GMT+2...
   - Стало: UTC+0, UTC+1, UTC+2...

2. **Изменен часовой пояс по умолчанию**
   - Было: UTC+0 (GMT)
   - Стало: UTC+3 (Московское время)

3. **Добавлена безопасность**
   - Токен бота теперь в `.env` файле
   - Исправлена критическая SQL-инъекция
   - Добавлена валидация всех входных данных

### Инструкция по обновлению

#### Для новых установок

Просто следуйте инструкциям в [README.md](README.md) - все настройки уже применены.

#### Для существующих установок

Если у вас уже есть работающий бот с базой данных:

1. **Создайте резервную копию базы данных**
   ```bash
   cp rates.db rates.db.backup
   ```

2. **Создайте файл `.env`**
   ```bash
   cp .env.example .env
   ```

3. **Добавьте токен бота в `.env`**
   Откройте `.env` и замените `your_bot_token_here` на ваш токен.

4. **Запустите миграцию часовых поясов** (опционально)

   Если ваши пользователи использовали UTC+0 (по умолчанию в старой версии), но на самом деле находятся в UTC+3 (Москва):

   ```bash
   python migrate_timezone.py
   ```

   Этот скрипт автоматически обновит всех пользователей с timezone=0 на timezone=3.

   **⚠️ ВНИМАНИЕ:** Запускайте миграцию только если вы уверены, что пользователи находятся в UTC+3!

5. **Запустите бота**
   ```bash
   python main.py
   ```

### Что произойдет с существующими пользователями

- Все настройки (валюты, дни, время) сохранятся
- Часовой пояс останется как был (0, 1, 2 и т.д.)
- Новые пользователи получат UTC+3 по умолчанию
- Пользователи могут изменить часовой пояс в настройках бота

### Проверка миграции

После обновления проверьте:

1. ✅ Бот запускается без ошибок
2. ✅ Логи пишутся в `bot.log`
3. ✅ Пользователи могут менять настройки
4. ✅ Уведомления приходят в правильное время

### Откат (если что-то пошло не так)

Если возникли проблемы:

1. Остановите бота (Ctrl+C)
2. Восстановите базу данных:
   ```bash
   cp rates.db.backup rates.db
   ```
3. Вернитесь к предыдущей версии кода:
   ```bash
   git checkout <предыдущий-коммит>
   ```

### Важные изменения в коде

Если вы модифицировали код, обратите внимание:

1. **database.py**
   - Добавлена валидация через whitelist в `update_settings()`
   - Изменен DEFAULT timezone с '0' на '3'

2. **keyboards.py**
   - Клавиатура часовых поясов теперь показывает UTC вместо GMT
   - Добавлено кеширование списка валют

3. **scheduler.py**
   - Использует константы из `config.py`
   - Улучшена защита от дублирования уведомлений

4. **config.py** (новые константы)
   ```python
   DEFAULT_TIMEZONE = 3
   DEFAULT_CURRENCIES = "USD,EUR"
   DEFAULT_WORKDAYS = [1, 2, 3, 4, 5]
   DEFAULT_NOTIFY_TIME = "08:00"
   ```

### Поддержка

Если у вас возникли проблемы с миграцией, создайте Issue в репозитории проекта.
